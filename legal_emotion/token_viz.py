from __future__ import annotations
import json
from pathlib import Path
from typing import Any, Dict


def _safe_js_object_literal(payload: Dict[str, Any]) -> str:
    s = json.dumps(
        payload,
        ensure_ascii=False,
    )
    return s.replace(
        '</',
        '<\\/',
    )


def write_token_ot_html_report(
    *,
    output_path: str | Path,
    payload: Dict[str, Any],
) -> str:
    out_p = Path(output_path)
    out_p.parent.mkdir(
        parents=True,
        exist_ok=True,
    )
    data_js = _safe_js_object_literal(payload)
    html = f'<!doctype html>\n<html lang="en">\n  <head>\n    <meta charset="utf-8" />\n    <meta name="viewport" content="width=device-width, initial-scale=1" />\n    <title>Token-Cloud OT Report</title>\n    <style>\n      :root {{\n        --bg: #0b1020;\n        --panel: #ffffff;\n        --muted: #64748b;\n        --border: #e2e8f0;\n        --ink: #0f172a;\n        --blue: #4f46e5;\n        --heat: #2563eb;\n      }}\n\n      * {{ box-sizing: border-box; }}\n      body {{\n        margin: 0;\n        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;\n        color: var(--ink);\n        background: #f8fafc;\n      }}\n\n      header {{\n        padding: 12px 16px;\n        background: var(--bg);\n        color: #fff;\n        border-bottom: 1px solid rgba(255, 255, 255, 0.12);\n      }}\n\n      header .row {{\n        display: flex;\n        align-items: baseline;\n        justify-content: space-between;\n        gap: 12px;\n        flex-wrap: wrap;\n      }}\n\n      header .title {{\n        font-weight: 700;\n        letter-spacing: 0.2px;\n      }}\n\n      header .subtitle {{\n        font-weight: 500;\n        color: rgba(255, 255, 255, 0.75);\n        margin-left: 10px;\n      }}\n\n      header .stats {{\n        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;\n        font-size: 12px;\n        color: rgba(255, 255, 255, 0.75);\n      }}\n\n      main {{\n        display: grid;\n        grid-template-columns: 340px 1fr;\n        min-height: calc(100vh - 54px);\n      }}\n\n      #sidebar {{\n        background: var(--panel);\n        border-right: 1px solid var(--border);\n        padding: 12px;\n        overflow: auto;\n      }}\n\n      #content {{\n        padding: 16px;\n        overflow: auto;\n      }}\n\n      .search {{\n        width: 100%;\n        padding: 10px 12px;\n        border-radius: 10px;\n        border: 1px solid var(--border);\n        outline: none;\n      }}\n\n      .doc-item {{\n        padding: 8px 10px;\n        border-radius: 10px;\n        cursor: pointer;\n        border: 1px solid transparent;\n        margin-top: 8px;\n      }}\n\n      .doc-item:hover {{\n        background: #f1f5f9;\n      }}\n\n      .doc-item.active {{\n        background: #eef2ff;\n        border-color: #c7d2fe;\n      }}\n\n      .doc-item .small {{\n        font-size: 12px;\n        color: var(--muted);\n        margin-top: 2px;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n      }}\n\n      h2 {{\n        margin: 0 0 6px 0;\n        font-size: 20px;\n      }}\n\n      h3 {{\n        margin: 16px 0 8px 0;\n        font-size: 14px;\n        color: #111827;\n      }}\n\n      .meta {{\n        border: 1px solid var(--border);\n        background: #fff;\n        border-radius: 12px;\n        padding: 10px 12px;\n      }}\n\n      .meta pre {{\n        margin: 0;\n        font-size: 12px;\n        overflow: auto;\n      }}\n\n      .pill {{\n        display: inline-block;\n        padding: 3px 8px;\n        border-radius: 999px;\n        background: #eef2ff;\n        color: #3730a3;\n        font-size: 12px;\n        font-weight: 600;\n      }}\n\n      .muted {{\n        color: var(--muted);\n        font-size: 12px;\n      }}\n\n      table {{\n        width: 100%;\n        border-collapse: collapse;\n        background: #fff;\n        border: 1px solid var(--border);\n        border-radius: 12px;\n        overflow: hidden;\n      }}\n\n      th, td {{\n        padding: 8px 10px;\n        border-bottom: 1px solid var(--border);\n        font-size: 12px;\n        vertical-align: top;\n      }}\n\n      th {{\n        background: #f8fafc;\n        color: #111827;\n        font-weight: 600;\n      }}\n\n      tr:hover td {{\n        background: #f8fafc;\n      }}\n\n      .clickable {{\n        cursor: pointer;\n      }}\n\n      .term {{\n        font-weight: 700;\n        color: #111827;\n      }}\n\n      .code {{\n        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;\n      }}\n\n      .grid2 {{\n        display: grid;\n        grid-template-columns: 1fr 1fr;\n        gap: 12px;\n      }}\n\n      .panel {{\n        border: 1px solid var(--border);\n        background: #fff;\n        border-radius: 12px;\n        padding: 10px 12px;\n      }}\n\n      .bar-row {{\n        display: grid;\n        grid-template-columns: 1fr 88px;\n        gap: 8px;\n        align-items: center;\n        margin: 6px 0;\n      }}\n\n      .bar {{\n        height: 10px;\n        background: #eef2ff;\n        border-radius: 999px;\n        overflow: hidden;\n      }}\n\n      .bar > div {{\n        height: 100%;\n        background: var(--blue);\n      }}\n\n      .controls {{\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        margin: 8px 0 6px 0;\n      }}\n\n      .btn {{\n        border: 1px solid var(--border);\n        background: #fff;\n        color: #111827;\n        padding: 4px 8px;\n        border-radius: 10px;\n        font-size: 12px;\n        cursor: pointer;\n        user-select: none;\n      }}\n\n      .btn.active {{\n        background: #eef2ff;\n        border-color: #c7d2fe;\n        color: #3730a3;\n        font-weight: 700;\n      }}\n\n      .cloud {{\n        display: flex;\n        flex-wrap: wrap;\n        gap: 8px 10px;\n        align-items: baseline;\n        margin-top: 8px;\n      }}\n\n      .cloud-term {{\n        display: inline-block;\n        padding: 3px 8px;\n        border-radius: 999px;\n        border: 1px solid var(--border);\n        background: #f8fafc;\n        line-height: 1.15;\n      }}\n\n      .cloud-term.highlight {{\n        background: #eef2ff;\n        border-color: #c7d2fe;\n      }}\n\n      .context {{\n        margin-top: 4px;\n        color: var(--muted);\n        font-size: 11px;\n        line-height: 1.25;\n        max-width: 520px;\n      }}\n    </style>\n  </head>\n  <body>\n    <header>\n      <div class="row">\n        <div>\n          <span class="title">Token-cloud OT report</span>\n          <span class="subtitle">explainable nearest neighbours</span>\n        </div>\n        <div class="stats" id="stats"></div>\n      </div>\n    </header>\n    <main>\n      <aside id="sidebar">\n        <input class="search" id="search" placeholder="Search docs..." />\n        <div id="docList"></div>\n      </aside>\n      <section id="content">\n        <h2 id="docTitle">Select a document</h2>\n        <div class="meta"><pre id="docMeta"></pre></div>\n\n        <div style="margin-top: 12px;" class="grid2">\n          <div class="panel">\n            <h3 style="margin-top: 0;">Top terms</h3>\n            <div class="muted" id="docStats"></div>\n            <div id="terms"></div>\n          </div>\n          <div class="panel">\n            <h3 style="margin-top: 0;">Nearest neighbours</h3>\n            <div class="muted" id="neighbourHint"></div>\n            <div id="neighbours"></div>\n          </div>\n        </div>\n\n        <div style="margin-top: 12px;" class="panel">\n          <h3 style="margin-top: 0;">Pair explanation</h3>\n          <div id="pairExplain" class="muted">Select a neighbour to view top transport flows.</div>\n        </div>\n      </section>\n    </main>\n    <script>\n      const DATA = {data_js};\n\n      function safeJson(x) {{\n        try {{ return JSON.stringify(x, null, 2); }} catch (e) {{ return String(x); }}\n      }}\n\n      function formatNum(x, digits=4) {{\n        const v = Number(x);\n        if (!isFinite(v)) return "n/a";\n        return v.toFixed(digits);\n      }}\n\n      function formatVad(v) {{\n        if (!Array.isArray(v) || v.length < 3) return "n/a";\n        return `V=${{formatNum(v[0], 2)}}  A=${{formatNum(v[1], 2)}}  D=${{formatNum(v[2], 2)}}`;\n      }}\n\n      function docLabel(doc) {{\n        const meta = doc && doc.meta ? doc.meta : {{}};\n        if (typeof meta.id === "string" && meta.id) return meta.id;\n        if (typeof meta.path === "string" && meta.path) return meta.path.split(/[\\\\/]/).slice(-1)[0];\n        if (typeof meta.category === "string" && meta.category) return `${{meta.category}} #${{doc.index}}`;\n        return `doc_${{doc.index}}`;\n      }}\n\n      const docs = Array.isArray(DATA.docs) ? DATA.docs : [];\n      const docsByIndex = new Map(docs.map(d => [d.index, d]));\n      const neighboursByIndex = new Map((DATA.neighbours || []).map(r => [r.index, r.neighbours || []]));\n      let activeDoc = docs.length ? docs[0].index : null;\n      let activeNeighbour = null;\n      let termsView = "cloud";\n      let flowsView = "contrib";\n\n      try {{\n        const saved = localStorage.getItem("token_ot_terms_view");\n        if (saved === "cloud" || saved === "bars") termsView = saved;\n      }} catch (e) {{}}\n      try {{\n        const saved = localStorage.getItem("token_ot_flows_view");\n        if (saved === "contrib" || saved === "mass") flowsView = saved;\n      }} catch (e) {{}}\n\n      function pickFlows(explain) {{\n        const byContrib = (explain && Array.isArray(explain.top_transport_cost_contrib)) ? explain.top_transport_cost_contrib : [];\n        const byMass = (explain && Array.isArray(explain.top_transport_mass)) ? explain.top_transport_mass : [];\n        if (flowsView === "mass" && byMass.length) return {{flows: byMass, label: "mass"}};\n        return {{flows: byContrib, label: "contrib"}};\n      }}\n\n      function renderDocList(filter="") {{\n        const list = document.getElementById("docList");\n        list.innerHTML = "";\n        const q = (filter || "").toLowerCase();\n        for (const doc of docs) {{\n          const label = docLabel(doc);\n          const meta = doc.meta || {{}};\n          const small = [\n            (meta.category ? `cat=${{meta.category}}` : null),\n            (doc.selected_ratio !== undefined ? `selected_ratio=${{formatNum(doc.selected_ratio, 4)}}` : null),\n            (doc.n_selected_tokens !== undefined ? `n_sel=${{doc.n_selected_tokens}}` : null),\n          ].filter(Boolean).join(" * ");\n          const hay = `${{label}} ${{small}} ${{safeJson(meta)}}`.toLowerCase();\n          if (q && !hay.includes(q)) continue;\n\n          const item = document.createElement("div");\n          item.className = "doc-item" + (doc.index === activeDoc ? " active" : "");\n          const title = document.createElement("div");\n          title.className = "term";\n          title.textContent = label;\n          const sub = document.createElement("div");\n          sub.className = "small";\n          sub.textContent = small;\n          item.appendChild(title);\n          item.appendChild(sub);\n          item.addEventListener("click", () => setDoc(doc.index));\n          list.appendChild(item);\n        }}\n      }}\n\n      function clamp01(x) {{\n        const v = Number(x);\n        if (!isFinite(v)) return 0;\n        return Math.max(0, Math.min(1, v));\n      }}\n\n      function termBgColor(vad, scale, sal) {{\n        if (!Array.isArray(vad) || vad.length < 3) return null;\n        const v = Number(vad[0]) || 0;\n        const a = Number(vad[1]) || 0;\n        const absV = clamp01(Math.abs(v));\n        const ar = clamp01(Math.max(0, a));\n        const s = (sal !== null && sal !== undefined && isFinite(Number(sal))) ? clamp01(sal) : Math.max(absV, ar);\n        const hue = v >= 0 ? 220 : 12;\n        const sat = 55 + 25 * absV;\n        const light = 96 - 18 * clamp01(0.35 * scale + 0.65 * s);\n        const alpha = 0.92;\n        return `hsla(${{hue}}, ${{sat}}%, ${{light}}%, ${{alpha}})`;\n      }}\n\n      function docTermRows(doc) {{\n        const terms = Array.isArray(doc.terms) ? doc.terms : [];\n        const weights = Array.isArray(doc.weights) ? doc.weights : [];\n        const termWeights = Array.isArray(doc.term_weight) ? doc.term_weight : [];\n        const sources = Array.isArray(doc.term_source) ? doc.term_source : [];\n        const salience = Array.isArray(doc.term_salience) ? doc.term_salience : [];\n        const vads = Array.isArray(doc.term_vad) ? doc.term_vad : [];\n        const rows = [];\n        const n = Math.min(terms.length, weights.length);\n        for (let i = 0; i < n; i++) {{\n          rows.push({{\n            term: terms[i],\n            weight: Number(weights[i]) || 0,\n            termWeight: (termWeights.length > i ? Number(termWeights[i]) : null),\n            source: sources[i],\n            salience: salience[i],\n            vad: vads[i],\n          }});\n        }}\n        rows.sort((a, b) => b.weight - a.weight);\n        return rows;\n      }}\n\n      function renderTermBars(container, shown) {{\n        container.innerHTML = "";\n        const maxW = shown.reduce((m, r) => Math.max(m, Math.abs(Number(r.weight) || 0)), 0) || 1;\n        for (const r of shown) {{\n          const t = r.term;\n          const w = r.weight;\n          const row = document.createElement("div");\n          row.className = "bar-row";\n          const left = document.createElement("div");\n          const term = document.createElement("span");\n          term.className = "term";\n          term.textContent = String(t);\n          left.appendChild(term);\n\n          const meta = [];\n          if (r.source) meta.push(`src=${{String(r.source)}}`);\n          if (r.termWeight !== null && r.termWeight !== undefined && isFinite(Number(r.termWeight))) {{\n            meta.push(`tw=${{formatNum(r.termWeight, 3)}}`);\n          }}\n          if (r.salience !== undefined && r.salience !== null && isFinite(Number(r.salience))) meta.push(`sal=${{formatNum(r.salience, 3)}}`);\n          if (Array.isArray(r.vad) && r.vad.length >= 3) meta.push(formatVad(r.vad));\n          if (meta.length) {{\n            const m = document.createElement("div");\n            m.className = "context code";\n            m.textContent = meta.join("  *  ");\n            left.appendChild(m);\n          }}\n\n          const bar = document.createElement("div");\n          bar.className = "bar";\n          const inner = document.createElement("div");\n          inner.style.width = `${{Math.min(100, (Math.abs(w) / maxW) * 100)}}%`;\n          bar.appendChild(inner);\n          const right = document.createElement("div");\n          right.className = "muted code";\n          right.style.textAlign = "right";\n          right.textContent = formatNum(w, 3);\n          row.appendChild(left);\n          row.appendChild(bar);\n          row.appendChild(right);\n          container.appendChild(row);\n        }}\n      }}\n\n      function renderTermCloud(container, shown, opts={{}}) {{\n        container.innerHTML = "";\n        const cloud = document.createElement("div");\n        cloud.className = "cloud";\n        const maxW = shown.reduce((m, r) => Math.max(m, Math.abs(Number(r.weight) || 0)), 0) || 1;\n        const hi = opts && opts.highlight ? opts.highlight : null;\n        const minPx = 12;\n        const maxPx = 34;\n        for (const r of shown) {{\n          const t = String(r.term || "");\n          if (!t) continue;\n          const w = Math.abs(Number(r.weight) || 0);\n          const norm = maxW > 0 ? (w / maxW) : 0;\n          const scale = Math.sqrt(clamp01(norm));\n          const fs = minPx + (maxPx - minPx) * scale;\n          const sp = document.createElement("span");\n          sp.className = "cloud-term";\n          if (hi && hi.has(t)) sp.classList.add("highlight");\n          sp.style.fontSize = `${{fs.toFixed(1)}}px`;\n          const bg = termBgColor(r.vad, scale, r.salience);\n          if (bg) sp.style.background = bg;\n          sp.textContent = t;\n\n          const meta = [];\n          if (r.source) meta.push(`src=${{String(r.source)}}`);\n          if (r.salience !== undefined && r.salience !== null && isFinite(Number(r.salience))) meta.push(`sal=${{formatNum(r.salience, 3)}}`);\n          meta.push(`w=${{formatNum(r.weight, 3)}}`);\n          if (Array.isArray(r.vad) && r.vad.length >= 3) meta.push(formatVad(r.vad));\n          sp.title = meta.join("  *  ");\n          cloud.appendChild(sp);\n        }}\n        container.appendChild(cloud);\n      }}\n\n      function renderTerms(doc, topN=32) {{\n        const container = document.getElementById("terms");\n        container.innerHTML = "";\n        const rows = docTermRows(doc);\n        const shown = rows.slice(0, Math.max(0, Number(topN) || 0));\n\n        const controls = document.createElement("div");\n        controls.className = "controls";\n        const label = document.createElement("div");\n        label.className = "muted";\n        label.textContent = "View:";\n        const btnCloud = document.createElement("button");\n        btnCloud.className = "btn" + (termsView === "cloud" ? " active" : "");\n        btnCloud.textContent = "Cloud";\n        const btnBars = document.createElement("button");\n        btnBars.className = "btn" + (termsView === "bars" ? " active" : "");\n        btnBars.textContent = "Bars";\n        controls.appendChild(label);\n        controls.appendChild(btnCloud);\n        controls.appendChild(btnBars);\n        container.appendChild(controls);\n\n        const view = document.createElement("div");\n        container.appendChild(view);\n\n        function rerender() {{\n          btnCloud.className = "btn" + (termsView === "cloud" ? " active" : "");\n          btnBars.className = "btn" + (termsView === "bars" ? " active" : "");\n          if (termsView === "bars") {{\n            renderTermBars(view, shown);\n          }} else {{\n            renderTermCloud(view, shown, null);\n          }}\n        }}\n\n        btnCloud.addEventListener("click", () => {{\n          termsView = "cloud";\n          try {{ localStorage.setItem("token_ot_terms_view", termsView); }} catch (e) {{}}\n          rerender();\n        }});\n        btnBars.addEventListener("click", () => {{\n          termsView = "bars";\n          try {{ localStorage.setItem("token_ot_terms_view", termsView); }} catch (e) {{}}\n          rerender();\n        }});\n        rerender();\n      }}\n\n      function renderNeighbours(docIndex) {{\n        const container = document.getElementById("neighbours");\n        container.innerHTML = "";\n        const neigh = neighboursByIndex.get(docIndex) || [];\n        if (!neigh.length) {{\n          container.innerHTML = `<div class="muted">No neighbours available.</div>`;\n          return;\n        }}\n        const table = document.createElement("table");\n        table.innerHTML = `\n          <thead>\n            <tr>\n              <th>neighbour</th>\n              <th>distance</th>\n              <th>mass_diff</th>\n            </tr>\n          </thead>\n          <tbody></tbody>\n        `;\n        const tbody = table.querySelector("tbody");\n        for (const n of neigh) {{\n          const j = Number(n.index);\n          const doc = docsByIndex.get(j);\n          const tr = document.createElement("tr");\n          tr.className = "clickable";\n          const td0 = document.createElement("td");\n          const sp = document.createElement("span");\n          sp.className = "term";\n          sp.textContent = doc ? docLabel(doc) : `doc_${{j}}`;\n          td0.appendChild(sp);\n          const td1 = document.createElement("td");\n          td1.className = "muted code";\n          td1.textContent = formatNum(n.distance);\n          const td2 = document.createElement("td");\n          td2.className = "muted code";\n          td2.textContent = formatNum(n.mass_diff);\n          tr.appendChild(td0);\n          tr.appendChild(td1);\n          tr.appendChild(td2);\n          tr.addEventListener("click", () => setPair(docIndex, j));\n          tbody.appendChild(tr);\n        }}\n        container.appendChild(table);\n      }}\n\n      function renderPairExplain(i, j) {{\n        const container = document.getElementById("pairExplain");\n        container.innerHTML = "";\n        const neigh = neighboursByIndex.get(i) || [];\n        const entry = neigh.find(x => Number(x.index) === Number(j));\n        const explain = entry && entry.primary_explain ? entry.primary_explain : null;\n        if (!explain) {{\n          container.className = "muted";\n          container.textContent = "No explanation data available for this pair.";\n          return;\n        }}\n        if (explain.error) {{\n          container.className = "muted";\n          container.textContent = explain.error;\n          return;\n        }}\n\n        const head = document.createElement("div");\n        head.innerHTML = `\n          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">\n            <span class="pill">${{explain.mode}}</span>\n            <span class="pill">cost=${{explain.cost}}</span>\n            <span class="pill">dist=${{formatNum(explain.distance)}}</span>\n            <span class="pill">Delta=${{formatNum(explain.distance_minus_calc)}}</span>\n          </div>\n          <div style="margin-top: 8px;" class="muted">\n            transport_ab=${{formatNum(explain.transport_ab)}} &nbsp; kl_a=${{formatNum(explain.kl_a)}} &nbsp; kl_b=${{formatNum(explain.kl_b)}} &nbsp;\n            mass_plan=${{formatNum(explain.mass_plan)}}\n          </div>\n        `;\n        container.appendChild(head);\n\n        const flowPack = pickFlows(explain);\n        const flows = flowPack.flows;\n        const docA = docsByIndex.get(i);\n        const docB = docsByIndex.get(j);\n        const flowControls = document.createElement("div");\n        flowControls.className = "controls";\n        flowControls.style.marginTop = "10px";\n        const flabel = document.createElement("div");\n        flabel.className = "muted";\n        flabel.textContent = "Flows ranked by:";\n        const btnContrib = document.createElement("button");\n        btnContrib.className = "btn" + (flowsView === "contrib" ? " active" : "");\n        btnContrib.textContent = "Contribution";\n        const btnMass = document.createElement("button");\n        btnMass.className = "btn" + (flowsView === "mass" ? " active" : "");\n        btnMass.textContent = "Mass";\n        flowControls.appendChild(flabel);\n        flowControls.appendChild(btnContrib);\n        flowControls.appendChild(btnMass);\n        container.appendChild(flowControls);\n\n        function rerenderFlowsOnly() {{\n          btnContrib.className = "btn" + (flowsView === "contrib" ? " active" : "");\n          btnMass.className = "btn" + (flowsView === "mass" ? " active" : "");\n          renderPairExplain(i, j);\n        }}\n        btnContrib.addEventListener("click", () => {{\n          flowsView = "contrib";\n          try {{ localStorage.setItem("token_ot_flows_view", flowsView); }} catch (e) {{}}\n          rerenderFlowsOnly();\n        }});\n        btnMass.addEventListener("click", () => {{\n          flowsView = "mass";\n          try {{ localStorage.setItem("token_ot_flows_view", flowsView); }} catch (e) {{}}\n          rerenderFlowsOnly();\n        }});\n\n        if (docA && docB && flows.length) {{\n          const hiA = new Set(flows.map(f => String((f && f.from) || "")).filter(Boolean));\n          const hiB = new Set(flows.map(f => String((f && f.to) || "")).filter(Boolean));\n          const grid = document.createElement("div");\n          grid.className = "grid2";\n          grid.style.marginTop = "12px";\n\n          const left = document.createElement("div");\n          left.className = "panel";\n          left.innerHTML = `<div class="muted">Doc A highlights (terms in top flows, ranked by ${{flowPack.label}})</div><div class="term">${{docLabel(docA)}}</div>`;\n          const leftCloud = document.createElement("div");\n          left.appendChild(leftCloud);\n\n          const right = document.createElement("div");\n          right.className = "panel";\n          right.innerHTML = `<div class="muted">Doc B highlights (terms in top flows, ranked by ${{flowPack.label}})</div><div class="term">${{docLabel(docB)}}</div>`;\n          const rightCloud = document.createElement("div");\n          right.appendChild(rightCloud);\n\n          grid.appendChild(left);\n          grid.appendChild(right);\n          container.appendChild(grid);\n\n          const rowsA = docTermRows(docA).slice(0, 48);\n          const rowsB = docTermRows(docB).slice(0, 48);\n          renderTermCloud(leftCloud, rowsA, {{highlight: hiA}});\n          renderTermCloud(rightCloud, rowsB, {{highlight: hiB}});\n        }}\n\n        if (!flows.length) {{\n          const m = document.createElement("div");\n          m.className = "muted";\n          m.style.marginTop = "10px";\n          m.textContent = "No transport-flow breakdown available.";\n          container.appendChild(m);\n          return;\n        }}\n\n        const table = document.createElement("table");\n        table.style.marginTop = "10px";\n        table.innerHTML = `\n          <thead>\n            <tr>\n              <th>from</th>\n              <th>to</th>\n              <th>mass</th>\n              <th>cost</th>\n              <th>embed</th>\n              <th>vad</th>\n              <th>contrib</th>\n            </tr>\n          </thead>\n          <tbody></tbody>\n        `;\n        const tbody = table.querySelector("tbody");\n        for (const f of flows) {{\n          const tr = document.createElement("tr");\n          const tdFrom = document.createElement("td");\n          const fromTerm = document.createElement("div");\n          fromTerm.className = "term";\n          fromTerm.textContent = String(f.from || "");\n          tdFrom.appendChild(fromTerm);\n          const fromMeta = [];\n          if (f.from_weight_norm !== null && f.from_weight_norm !== undefined) fromMeta.push(`w_norm=${{formatNum(f.from_weight_norm, 4)}}`);\n          if (f.from_weight_raw !== null && f.from_weight_raw !== undefined) fromMeta.push(`w_raw=${{formatNum(f.from_weight_raw, 4)}}`);\n          if (Array.isArray(f.from_vad) && f.from_vad.length >= 3) fromMeta.push(formatVad(f.from_vad));\n          if (fromMeta.length) {{\n            const m = document.createElement("div");\n            m.className = "context code";\n            m.textContent = fromMeta.join("  *  ");\n            tdFrom.appendChild(m);\n          }}\n          if (f.from_context) {{\n            const ctx = document.createElement("div");\n            ctx.className = "context";\n            ctx.textContent = String(f.from_context);\n            tdFrom.appendChild(ctx);\n          }}\n\n          const tdTo = document.createElement("td");\n          const toTerm = document.createElement("div");\n          toTerm.className = "term";\n          toTerm.textContent = String(f.to || "");\n          tdTo.appendChild(toTerm);\n          const toMeta = [];\n          if (f.to_weight_norm !== null && f.to_weight_norm !== undefined) toMeta.push(`w_norm=${{formatNum(f.to_weight_norm, 4)}}`);\n          if (f.to_weight_raw !== null && f.to_weight_raw !== undefined) toMeta.push(`w_raw=${{formatNum(f.to_weight_raw, 4)}}`);\n          if (Array.isArray(f.to_vad) && f.to_vad.length >= 3) toMeta.push(formatVad(f.to_vad));\n          if (toMeta.length) {{\n            const m = document.createElement("div");\n            m.className = "context code";\n            m.textContent = toMeta.join("  *  ");\n            tdTo.appendChild(m);\n          }}\n          if (f.to_context) {{\n            const ctx = document.createElement("div");\n            ctx.className = "context";\n            ctx.textContent = String(f.to_context);\n            tdTo.appendChild(ctx);\n          }}\n\n          const tdMass = document.createElement("td");\n          tdMass.className = "muted code";\n          tdMass.textContent = formatNum(f.mass);\n\n          const tdCost = document.createElement("td");\n          tdCost.className = "muted code";\n          tdCost.textContent = formatNum(f.cost);\n\n          const tdEmbed = document.createElement("td");\n          tdEmbed.className = "muted code";\n          tdEmbed.textContent = (f.cost_embed === null || f.cost_embed === undefined) ? "" : formatNum(f.cost_embed);\n\n          const tdVad = document.createElement("td");\n          tdVad.className = "muted code";\n          tdVad.textContent = (f.cost_vad === null || f.cost_vad === undefined) ? "" : formatNum(f.cost_vad);\n\n          const tdContrib = document.createElement("td");\n          tdContrib.className = "muted code";\n          tdContrib.textContent = formatNum(f.contribution);\n\n          tr.appendChild(tdFrom);\n          tr.appendChild(tdTo);\n          tr.appendChild(tdMass);\n          tr.appendChild(tdCost);\n          tr.appendChild(tdEmbed);\n          tr.appendChild(tdVad);\n          tr.appendChild(tdContrib);\n          tbody.appendChild(tr);\n        }}\n        container.appendChild(table);\n      }}\n\n      function setDoc(index) {{\n        activeDoc = Number(index);\n        activeNeighbour = null;\n        renderDocList(document.getElementById("search").value);\n        const doc = docsByIndex.get(activeDoc);\n        if (!doc) return;\n        document.getElementById("docTitle").textContent = docLabel(doc);\n        document.getElementById("docMeta").textContent = safeJson(doc.meta || {{}});\n\n        const hint = document.getElementById("neighbourHint");\n        hint.textContent = `mode=${{DATA.mode}} focus=${{DATA.focus}} cost=${{DATA.cost}} topk=${{DATA.topk}}`;\n\n        const ds = document.getElementById("docStats");\n        ds.textContent = `n_terms=${{doc.n_terms}}  n_raw=${{doc.n_raw_tokens}}  n_selected=${{doc.n_selected_tokens}}  selected_ratio=${{formatNum(doc.selected_ratio,4)}}  mass=${{formatNum(doc.mass)}}`;\n\n        renderTerms(doc, 36);\n        renderNeighbours(activeDoc);\n        const pe = document.getElementById("pairExplain");\n        pe.className = "muted";\n        pe.textContent = "Select a neighbour to view top transport flows.";\n      }}\n\n      function setPair(i, j) {{\n        activeDoc = Number(i);\n        activeNeighbour = Number(j);\n        renderDocList(document.getElementById("search").value);\n        renderPairExplain(activeDoc, activeNeighbour);\n      }}\n\n      document.getElementById("search").addEventListener("input", (e) => {{\n        renderDocList(e.target.value);\n      }});\n\n      const statsEl = document.getElementById("stats");\n      const extra = [];\n      if (DATA.emotional_vocab) extra.push(`vocab=${{DATA.emotional_vocab}}`);\n      if (DATA.vad_min_arousal_vad_only !== null && DATA.vad_min_arousal_vad_only !== undefined && isFinite(Number(DATA.vad_min_arousal_vad_only))) {{\n        extra.push(`vad_min_arousal_vad_only=${{formatNum(DATA.vad_min_arousal_vad_only, 3)}}`);\n      }}\n      statsEl.textContent = `docs=${{docs.length}}  mode=${{DATA.mode}}  focus=${{DATA.focus}}  cost=${{DATA.cost}}  embed=${{DATA.embed_model || "n/a"}}${{extra.length ? "  " + extra.join("  ") : ""}}`;\n\n      renderDocList("");\n      if (activeDoc !== null) setDoc(activeDoc);\n    </script>\n  </body>\n</html>\n'
    out_p.write_text(
        html,
        encoding='utf-8',
    )
    return str(out_p)
